---
title: è‡ªå®šä¹‰loaderï¼šå‰ç«¯å›½é™…åŒ–èµ„æºè‡ªåŠ¨æå–å·¥å…·i18n-extract-loader
date: '2024-07-13'
tags: ['Webpack']
draft: false
summary: åŸºäºASTè§£æçš„è‡ªåŠ¨åŒ–å›½é™…åŒ–èµ„æºæå–Loaderï¼Œæ”¯æŒJS/JSX/TS/TSXï¼Œè‡ªåŠ¨è¯†åˆ«ä¸­æ–‡æ–‡æœ¬ã€ç”Ÿæˆç¿»è¯‘Keyã€æ³¨å…¥å›½é™…åŒ–è°ƒç”¨å¹¶è¾“å‡ºå¤šè¯­è¨€æ–‡ä»¶ï¼Œå¤§å¹…æå‡å¤šè¯­è¨€æ”¹é€ æ•ˆç‡
---

# i18n-extract-loader ä½¿ç”¨æŒ‡å—

ä¸€æ¬¾åŸºäºASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰åˆ†æçš„å‰ç«¯å›½é™…åŒ–èµ„æºè‡ªåŠ¨æå–å·¥å…·ï¼Œèƒ½å¤Ÿæ™ºèƒ½è¯†åˆ«ä»£ç ä¸­çš„ä¸­æ–‡æ–‡æœ¬ï¼Œè‡ªåŠ¨ç”Ÿæˆi18n Keyã€æ›¿æ¢ä¸ºå›½é™…åŒ–å‡½æ•°è°ƒç”¨ï¼Œå¹¶è¾“å‡ºå¤šè¯­è¨€ç¿»è¯‘æ–‡ä»¶æ¨¡æ¿ï¼Œè®©å‰ç«¯é¡¹ç›®çš„å›½é™…åŒ–æ”¹é€ æ•ˆç‡æå‡10å€ä»¥ä¸Šï¼

## ğŸ§° æ ¸å¿ƒLoaderå®ç°ä»£ç 

```javascript
// loaders/i18n-extract-loader.js
const path = require('path');
const fs = require('fs');
const crypto = require('crypto');
const { parse } = require('@babel/parser');
const traverse = require('@babel/traverse').default;
const generate = require('@babel/generator').default;
const t = require('@babel/types');

/**
 * å›½é™…åŒ–èµ„æºè‡ªåŠ¨æå– Loader
 * è‡ªåŠ¨æ‰«æä»£ç ä¸­çš„ä¸­æ–‡æ–‡æœ¬ï¼Œç”Ÿæˆ i18n key å¹¶æ›¿æ¢
 */
module.exports = function i18nExtractLoader(source) {
  const callback = this.async();
  const options = this.getOptions() || {};

  // é…ç½®é¡¹
  const config = {
    // è¾“å‡ºç¿»è¯‘æ–‡ä»¶çš„ç›®å½•
    outputDir: options.outputDir || path.join(process.cwd(), 'src/locales'),
    // i18n å‡½æ•°åç§°
    i18nFunctionName: options.i18nFunctionName || 't',
    // å¯¼å…¥è¯­å¥
    i18nImportStatement: options.i18nImportStatement || "import { t } from '@/i18n'",
    // æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆ keyï¼ˆfalse åˆ™ä½¿ç”¨ä¸­æ–‡åŸæ–‡ä½œä¸º keyï¼‰
    autoGenerateKey: options.autoGenerateKey !== false,
    // key å‰ç¼€
    keyPrefix: options.keyPrefix || '',
    // æ˜¯å¦è·³è¿‡å·²æœ‰ i18n è°ƒç”¨çš„æ–‡ä»¶
    skipIfHasI18n: options.skipIfHasI18n || false,
    // ä¸­æ–‡æ­£åˆ™ï¼ˆåŒ¹é…åŒ…å«ä¸­æ–‡çš„å­—ç¬¦ä¸²ï¼‰
    chineseRegex: options.chineseRegex || /[\u4e00-\u9fa5]/,
    // æ’é™¤çš„æ–‡æœ¬ï¼ˆå¦‚"ä¸­å›½"ã€"OK"ç­‰ä¸éœ€è¦ç¿»è¯‘çš„ï¼‰
    excludeTexts: options.excludeTexts || [],
    // æœ€å°æ–‡æœ¬é•¿åº¦ï¼ˆçŸ­æ–‡æœ¬å¯èƒ½ä¸éœ€è¦ç¿»è¯‘ï¼‰
    minTextLength: options.minTextLength || 1,
    // æ˜¯å¦ç”Ÿæˆç¿»è¯‘æ–‡ä»¶
    generateFiles: options.generateFiles !== false,
    // ç¿»è¯‘æ–‡ä»¶è¯­è¨€
    languages: options.languages || ['zh-CN', 'en-US'],
  };

  try {
    // è§£ææºä»£ç ä¸º AST
    const ast = parse(source, {
      sourceType: 'module',
      plugins: [
        'jsx',
        'typescript',
        'decorators-legacy',
        'classProperties',
        'dynamicImport',
      ],
    });

    // å­˜å‚¨æå–çš„æ–‡æœ¬
    const extractedTexts = new Map();
    let hasI18nImport = false;
    let needsI18nImport = false;

    // æ£€æŸ¥æ˜¯å¦å·²ç»å¯¼å…¥äº† i18n
    traverse(ast, {
      ImportDeclaration(path) {
        const importSource = path.node.source.value;
        if (importSource.includes('i18n') || importSource.includes('locale')) {
          hasI18nImport = true;
        }
      },
    });

    // å¦‚æœé…ç½®äº†è·³è¿‡å·²æœ‰ i18n çš„æ–‡ä»¶ï¼Œä¸”æ–‡ä»¶å·²æœ‰å¯¼å…¥ï¼Œåˆ™ç›´æ¥è¿”å›
    if (config.skipIfHasI18n && hasI18nImport) {
      callback(null, source);
      return;
    }

    // éå† ASTï¼ŒæŸ¥æ‰¾ä¸­æ–‡æ–‡æœ¬
    traverse(ast, {
      // å¤„ç†å­—ç¬¦ä¸²å­—é¢é‡
      StringLiteral(path) {
        const text = path.node.value;

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç†
        if (!shouldExtractText(text, config, path)) {
          return;
        }

        // ç”Ÿæˆ key
        const key = generateKey(text, config, extractedTexts);
        extractedTexts.set(key, text);

        // æ›¿æ¢ä¸º i18n è°ƒç”¨
        const i18nCall = t.callExpression(
          t.identifier(config.i18nFunctionName),
          [t.stringLiteral(key)]
        );

        path.replaceWith(i18nCall);
        needsI18nImport = true;
      },

      // å¤„ç†æ¨¡æ¿å­—é¢é‡ï¼ˆå¦‚æœæ•´ä¸ªæ¨¡æ¿éƒ½æ˜¯ä¸­æ–‡ï¼‰
      TemplateLiteral(path) {
        // åªå¤„ç†æ²¡æœ‰è¡¨è¾¾å¼çš„ç®€å•æ¨¡æ¿å­—ç¬¦ä¸²
        if (path.node.expressions.length === 0 && path.node.quasis.length === 1) {
          const text = path.node.quasis[0].value.cooked;

          if (!shouldExtractText(text, config, path)) {
            return;
          }

          const key = generateKey(text, config, extractedTexts);
          extractedTexts.set(key, text);

          const i18nCall = t.callExpression(
            t.identifier(config.i18nFunctionName),
            [t.stringLiteral(key)]
          );

          path.replaceWith(i18nCall);
          needsI18nImport = true;
        }
      },

      // å¤„ç† JSX æ–‡æœ¬
      JSXText(path) {
        const text = path.node.value.trim();

        if (!shouldExtractText(text, config, path)) {
          return;
        }

        const key = generateKey(text, config, extractedTexts);
        extractedTexts.set(key, text);

        // æ›¿æ¢ä¸º JSX è¡¨è¾¾å¼
        const i18nCall = t.jSXExpressionContainer(
          t.callExpression(
            t.identifier(config.i18nFunctionName),
            [t.stringLiteral(key)]
          )
        );

        path.replaceWith(i18nCall);
        needsI18nImport = true;
      },
    });

    // å¦‚æœéœ€è¦ï¼Œæ·»åŠ  i18n å¯¼å…¥è¯­å¥
    if (needsI18nImport && !hasI18nImport) {
      const importAst = parse(config.i18nImportStatement, {
        sourceType: 'module',
      });

      ast.program.body.unshift(importAst.program.body[0]);
    }

    // ç”Ÿæˆç¿»è¯‘æ–‡ä»¶
    if (config.generateFiles && extractedTexts.size > 0) {
      generateTranslationFiles(extractedTexts, config, this.resourcePath);
    }

    // ç”Ÿæˆä¿®æ”¹åçš„ä»£ç 
    const output = generate(ast, {
      retainLines: true,
      comments: true,
    });

    callback(null, output.code);
  } catch (error) {
    callback(error);
  }
};

/**
 * åˆ¤æ–­æ–‡æœ¬æ˜¯å¦éœ€è¦æå–
 */
function shouldExtractText(text, config, path) {
  // ç©ºæ–‡æœ¬
  if (!text || !text.trim()) {
    return false;
  }

  // æ–‡æœ¬å¤ªçŸ­
  if (text.trim().length < config.minTextLength) {
    return false;
  }

  // ä¸åŒ…å«ä¸­æ–‡
  if (!config.chineseRegex.test(text)) {
    return false;
  }

  // åœ¨æ’é™¤åˆ—è¡¨ä¸­
  if (config.excludeTexts.includes(text.trim())) {
    return false;
  }

  // å·²ç»æ˜¯ i18n è°ƒç”¨
  if (path.parent && path.parent.type === 'CallExpression') {
    const callee = path.parent.callee;
    if (callee.name === config.i18nFunctionName) {
      return false;
    }
  }

  // JSX å±æ€§ä¸­çš„ç‰¹æ®Šæƒ…å†µï¼ˆå¦‚ className, style ç­‰ï¼‰
  if (path.parent && path.parent.type === 'JSXAttribute') {
    const attrName = path.parent.name.name;
    const skipAttrs = ['className', 'style', 'key', 'ref', 'id'];
    if (skipAttrs.includes(attrName)) {
      return false;
    }
  }

  return true;
}

/**
 * ç”Ÿæˆ i18n key
 */
function generateKey(text, config, existingTexts) {
  if (!config.autoGenerateKey) {
    // ä½¿ç”¨åŸæ–‡ä½œä¸º key
    return text.trim();
  }

  // è‡ªåŠ¨ç”Ÿæˆ key
  const prefix = config.keyPrefix;
  
  // æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ‹¼éŸ³é¦–å­—æ¯ + çŸ­hashï¼ˆæ¨èï¼‰
  const cleanText = text.trim().replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '');
  const hash = crypto
    .createHash('md5')
    .update(cleanText)
    .digest('hex')
    .substring(0, 6);

  // ç®€å•çš„æ‹¼éŸ³é¦–å­—æ¯æå–ï¼ˆä»…ä½œç¤ºä¾‹ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ pinyin åº“ï¼‰
  let pinyinKey = '';
  for (let i = 0; i < Math.min(cleanText.length, 4); i++) {
    const char = cleanText[i];
    if (/[\u4e00-\u9fa5]/.test(char)) {
      // ç®€åŒ–å¤„ç†ï¼šå¯ä»¥é›†æˆ pinyin åº“è·å–çœŸå®æ‹¼éŸ³
      pinyinKey += 'cn';
    } else {
      pinyinKey += char.toLowerCase();
    }
  }

  let key = `${prefix}${pinyinKey}_${hash}`;

  // ç¡®ä¿ key å”¯ä¸€
  let counter = 1;
  let finalKey = key;
  while (Array.from(existingTexts.keys()).includes(finalKey)) {
    finalKey = `${key}_${counter}`;
    counter++;
  }

  return finalKey;
}

/**
 * ç”Ÿæˆç¿»è¯‘æ–‡ä»¶
 */
function generateTranslationFiles(extractedTexts, config, resourcePath) {
  const outputDir = config.outputDir;

  // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  // ä¸ºæ¯ç§è¯­è¨€ç”Ÿæˆç¿»è¯‘æ–‡ä»¶
  config.languages.forEach((lang) => {
    const filePath = path.join(outputDir, `${lang}.json`);

    // è¯»å–ç°æœ‰ç¿»è¯‘æ–‡ä»¶
    let existingTranslations = {};
    if (fs.existsSync(filePath)) {
      try {
        existingTranslations = JSON.parse(fs.readFileSync(filePath, 'utf-8'));
      } catch (e) {
        console.warn(`Warning: Failed to parse existing ${lang}.json`);
      }
    }

    // åˆå¹¶æ–°æå–çš„æ–‡æœ¬
    const newTranslations = { ...existingTranslations };
    
    extractedTexts.forEach((text, key) => {
      if (!newTranslations[key]) {
        if (lang === 'zh-CN') {
          // ä¸­æ–‡ç›´æ¥ä½¿ç”¨åŸæ–‡
          newTranslations[key] = text;
        } else {
          // å…¶ä»–è¯­è¨€æ ‡è®°ä¸ºå¾…ç¿»è¯‘
          newTranslations[key] = `[TODO] ${text}`;
        }
      }
    });

    // å†™å…¥æ–‡ä»¶ï¼ˆæ ¼å¼åŒ– JSONï¼‰
    fs.writeFileSync(
      filePath,
      JSON.stringify(newTranslations, null, 2),
      'utf-8'
    );
  });

  // ç”Ÿæˆæå–æ—¥å¿—
  const logPath = path.join(outputDir, 'extraction-log.txt');
  const logEntry = `
===========================================
Extraction Time: ${new Date().toISOString()}
Source File: ${resourcePath}
Extracted Count: ${extractedTexts.size}
===========================================
${Array.from(extractedTexts.entries())
  .map(([key, text]) => `${key}: ${text}`)
  .join('\n')}

`;

  fs.appendFileSync(logPath, logEntry, 'utf-8');
}

// å¯¼å‡º raw loaderï¼ˆå¤„ç†åŸå§‹æºç ï¼‰
module.exports.raw = false;
```

## ğŸ’¡ æŠ€æœ¯åŸç†è¯´æ˜

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **@babel/parser**ï¼šå°†æºä»£ç è§£æä¸ºASTæŠ½è±¡è¯­æ³•æ ‘
- **@babel/traverse**ï¼šéå†ASTèŠ‚ç‚¹ï¼Œè¯†åˆ«StringLiteralã€JSXTextç­‰åŒ…å«ä¸­æ–‡çš„èŠ‚ç‚¹
- **@babel/generator**ï¼šå°†ä¿®æ”¹åçš„ASTé‡æ–°ç”ŸæˆJavaScriptä»£ç 
- **@babel/types**ï¼šåˆ›å»ºæ–°çš„ASTèŠ‚ç‚¹ï¼ˆå¦‚i18nå‡½æ•°è°ƒç”¨ã€å¯¼å…¥è¯­å¥ï¼‰

### å…³é”®å¤„ç†æµç¨‹
1. **ASTè§£æ**ï¼šå°†æºç è½¬æ¢ä¸ºç»“æ„åŒ–çš„ASTæ ‘
2. **æ–‡æœ¬è¯†åˆ«**ï¼šéå†ASTèŠ‚ç‚¹ï¼Œç­›é€‰ç¬¦åˆæ¡ä»¶çš„ä¸­æ–‡æ–‡æœ¬
3. **Keyç”Ÿæˆ**ï¼šé€šè¿‡æ‹¼éŸ³+å“ˆå¸Œç”Ÿæˆå”¯ä¸€çš„å›½é™…åŒ–Key
4. **èŠ‚ç‚¹æ›¿æ¢**ï¼šå°†æ–‡æœ¬èŠ‚ç‚¹æ›¿æ¢ä¸ºi18nå‡½æ•°è°ƒç”¨èŠ‚ç‚¹
5. **å¯¼å…¥æ³¨å…¥**ï¼šè‡ªåŠ¨æ·»åŠ i18nå‡½æ•°çš„å¯¼å…¥è¯­å¥
6. **æ–‡ä»¶ç”Ÿæˆ**ï¼šæŒ‰è¯­è¨€ç”Ÿæˆç¿»è¯‘JSONæ–‡ä»¶ï¼Œå¢é‡æ›´æ–°

## ğŸ“¦ å®‰è£…ä¾èµ–

```bash
# æ ¸å¿ƒASTå¤„ç†ä¾èµ–
npm install --save-dev @babel/parser @babel/traverse @babel/generator @babel/types
# WebpackåŸºç¡€ä¾èµ–ï¼ˆå¦‚æœªå®‰è£…ï¼‰
npm install --save-dev webpack webpack-cli babel-loader @babel/core
# React/TypeScripté¡¹ç›®é¢å¤–ä¾èµ–
npm install --save-dev @babel/preset-react @babel/preset-typescript
# å›½é™…åŒ–è¿è¡Œæ—¶ï¼ˆé…åˆä½¿ç”¨ï¼‰
npm install --save i18next react-i18next
```

## ğŸ”§ Webpack é…ç½®

### 1. åŸºç¡€é…ç½®

```javascript
// webpack.config.js
const path = require('path');

module.exports = {
  mode: 'development',
  entry: './src/index.js',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'bundle.js',
  },
  module: {
    rules: [
      {
        test: /\.(js|jsx|ts|tsx)$/,
        exclude: /node_modules/,
        use: [
          {
            loader: 'babel-loader',
            options: {
              presets: ['@babel/preset-react', '@babel/preset-typescript'],
            },
          },
          {
            loader: path.resolve(__dirname, './loaders/i18n-extract-loader.js'),
            options: {
              // ç¿»è¯‘æ–‡ä»¶è¾“å‡ºç›®å½•
              outputDir: path.join(__dirname, 'src/locales'),
              // i18nå‡½æ•°åç§°ï¼ˆå¦‚tã€$tï¼‰
              i18nFunctionName: 't',
              // å›½é™…åŒ–å‡½æ•°å¯¼å…¥è¯­å¥
              i18nImportStatement: "import { t } from '@/i18n'",
              // æ˜¯å¦è‡ªåŠ¨ç”ŸæˆKeyï¼ˆfalseåˆ™ä½¿ç”¨åŸæ–‡ä½œä¸ºKeyï¼‰
              autoGenerateKey: true,
              // Keyå‰ç¼€ï¼ˆæŒ‰æ¨¡å—åŒºåˆ†ï¼‰
              keyPrefix: 'common_',
              // æ’é™¤æ— éœ€å¤„ç†çš„æ–‡æœ¬
              excludeTexts: ['OK', 'Error', 'Success', 'React'],
              // æœ€å°æ–‡æœ¬é•¿åº¦ï¼ˆè¿‡æ»¤çŸ­æ–‡æœ¬ï¼‰
              minTextLength: 1,
              // æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
              languages: ['zh-CN', 'en-US', 'ja-JP'],
              // æ˜¯å¦ç”Ÿæˆç¿»è¯‘æ–‡ä»¶
              generateFiles: true,
            },
          },
        ],
      },
    ],
  },
  resolve: {
    extensions: ['.js', '.jsx', '.ts', '.tsx'],
    alias: {
      '@': path.resolve(__dirname, 'src'),
    },
  },
};
```

### 2. æŒ‰æ¨¡å—å·®å¼‚åŒ–é…ç½®

```javascript
// webpack.config.js
const path = require('path');
const modules = [
  { path: 'src/modules/auth', prefix: 'auth_' },
  { path: 'src/modules/user', prefix: 'user_' },
  { path: 'src/modules/product', prefix: 'product_' },
  { path: 'src/modules/order', prefix: 'order_' },
];

module.exports = {
  // ...å…¶ä»–é…ç½®
  module: {
    rules: [
      // æ¨¡å—å·®å¼‚åŒ–é…ç½®
      ...modules.map(mod => ({
        test: /\.(js|jsx)$/,
        include: path.resolve(__dirname, mod.path),
        use: [
          'babel-loader',
          {
            loader: './loaders/i18n-extract-loader.js',
            options: {
              keyPrefix: mod.prefix,
              outputDir: './src/locales',
              languages: ['zh-CN', 'en-US'],
            },
          },
        ],
      })),
      // é€šç”¨æ¨¡å—é…ç½®
      {
        test: /\.(js|jsx)$/,
        include: path.resolve(__dirname, 'src/common'),
        use: [
          'babel-loader',
          {
            loader: './loaders/i18n-extract-loader.js',
            options: {
              keyPrefix: 'common_',
              outputDir: './src/locales',
            },
          },
        ],
      },
    ],
  },
};
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### è½¬æ¢å‰ï¼ˆåŸå§‹ä»£ç ï¼‰

```jsx
// src/components/UserProfile.jsx
import React from 'react';

function UserProfile({ name }) {
  return (
    <div>
      <h1>ç”¨æˆ·ä¿¡æ¯</h1>
      <p>æ¬¢è¿å›æ¥ï¼Œ{name}!</p>
      <button>ç¼–è¾‘èµ„æ–™</button>
      <span title="è¿™æ˜¯æç¤º">æ‚¬åœæŸ¥çœ‹</span>
    </div>
  );
}

const message = "ç™»å½•æˆåŠŸ";
const template = `æ‚¨æœ‰ ${count} æ¡æ–°æ¶ˆæ¯`; // å«å˜é‡ï¼Œä¸å¤„ç†
```

### è½¬æ¢åï¼ˆè‡ªåŠ¨å›½é™…åŒ–ï¼‰

```jsx
// src/components/UserProfile.jsx
import { t } from '@/i18n';
import React from 'react';

function UserProfile({ name }) {
  return (
    <div>
      <h1>{t('user_yhxx_a1b2c3')}</h1>
      <p>{t('user_hghl_d4e5f6')}, {name}!</p>
      <button>{t('user_bjzl_g7h8i9')}</button>
      <span title={t('user_zsst_j0k1l2')}>{t('user_xftc_m3n4o5')}</span>
    </div>
  );
}

const message = t('user_dlcg_p6q7r8');
const template = `æ‚¨æœ‰ ${count} æ¡æ–°æ¶ˆæ¯`; // ä¿æŒä¸å˜
```

### è‡ªåŠ¨ç”Ÿæˆçš„ç¿»è¯‘æ–‡ä»¶

```json
// src/locales/zh-CN.json
{
  "user_yhxx_a1b2c3": "ç”¨æˆ·ä¿¡æ¯",
  "user_hghl_d4e5f6": "æ¬¢è¿å›æ¥",
  "user_bjzl_g7h8i9": "ç¼–è¾‘èµ„æ–™",
  "user_zsst_j0k1l2": "è¿™æ˜¯æç¤º",
  "user_xftc_m3n4o5": "æ‚¬åœæŸ¥çœ‹",
  "user_dlcg_p6q7r8": "ç™»å½•æˆåŠŸ"
}

// src/locales/en-US.json
{
  "user_yhxx_a1b2c3": "[TODO] ç”¨æˆ·ä¿¡æ¯",
  "user_hghl_d4e5f6": "[TODO] æ¬¢è¿å›æ¥",
  "user_bjzl_g7h8i9": "[TODO] ç¼–è¾‘èµ„æ–™",
  "user_zsst_j0k1l2": "[TODO] è¿™æ˜¯æç¤º",
  "user_xftc_m3n4o5": "[TODO] æ‚¬åœæŸ¥çœ‹",
  "user_dlcg_p6q7r8": "[TODO] ç™»å½•æˆåŠŸ"
}

// src/locales/ja-JP.json
{
  "user_yhxx_a1b2c3": "[TODO] ç”¨æˆ·æƒ…å ±",
  "user_hghl_d4e5f6": "[TODO] ãŠã‹ãˆã‚Šãªã•ã„",
  "user_bjzl_g7h8i9": "[TODO] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†",
  "user_zsst_j0k1l2": "[TODO] ã“ã‚Œã¯ãƒ’ãƒ³ãƒˆã§ã™",
  "user_xftc_m3n4o5": "[TODO] ãƒ›ãƒãƒ¼ã—ã¦è¡¨ç¤º",
  "user_dlcg_p6q7r8": "[TODO] ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ"
}
```

## ğŸ¯ é«˜çº§ç”¨æ³•

### 1. è·³è¿‡å·²å›½é™…åŒ–çš„æ–‡ä»¶

```javascript
{
  loader: './loaders/i18n-extract-loader.js',
  options: {
    skipIfHasI18n: true, // æ£€æµ‹åˆ°i18nå¯¼å…¥åˆ™è·³è¿‡å¤„ç†
  },
}
```

### 2. ä½¿ç”¨åŸæ–‡ä½œä¸ºKey

```javascript
{
  loader: './loaders/i18n-extract-loader.js',
  options: {
    autoGenerateKey: false, // ç¦ç”¨è‡ªåŠ¨ç”ŸæˆKey
  },
}
```

è½¬æ¢ç»“æœï¼š
```jsx
<h1>{t('ç”¨æˆ·ä¿¡æ¯')}</h1>
<button>{t('ç¼–è¾‘èµ„æ–™')}</button>
```

### 3. è‡ªå®šä¹‰ä¸­æ–‡æ£€æµ‹è§„åˆ™

```javascript
{
  loader: './loaders/i18n-extract-loader.js',
  options: {
    // åŒ¹é…ä¸­æ—¥éŸ©æ–‡
    chineseRegex: /[\u4e00-\u9fa5\u3040-\u309F\u30A0-\u30FF\uAC00-\uD7AF]/,
  },
}
```

### 4. æ’é™¤ç‰¹å®šæ–‡æœ¬

```javascript
{
  loader: './loaders/i18n-extract-loader.js',
  options: {
    excludeTexts: [
      'China',
      'Beijing',
      'WeChat',
      'Alipay',
      // å“ç‰Œåã€ä¸“æœ‰åè¯ç­‰æ— éœ€ç¿»è¯‘çš„æ–‡æœ¬
    ],
  },
}
```

## ğŸš€ æœ€ä½³å®è·µ

### 1. æŒ‰åŠŸèƒ½æ¨¡å—è®¾ç½®å‰ç¼€

```javascript
const modules = [
  { path: 'src/auth', prefix: 'auth_' },
  { path: 'src/user', prefix: 'user_' },
  { path: 'src/product', prefix: 'product_' },
  { path: 'src/order', prefix: 'order_' },
  { path: 'src/common', prefix: 'common_' },
];

module.exports = {
  module: {
    rules: modules.map(mod => ({
      test: /\.(js|jsx)$/,
      include: path.resolve(__dirname, mod.path),
      use: [
        'babel-loader',
        {
          loader: './loaders/i18n-extract-loader.js',
          options: { keyPrefix: mod.prefix },
        },
      ],
    })),
  },
};
```

### 2. å¼€å‘/ç”Ÿäº§ç¯å¢ƒå·®å¼‚åŒ–é…ç½®

```javascript
const isDev = process.env.NODE_ENV === 'development';

module.exports = {
  module: {
    rules: [
      {
        test: /\.(js|jsx)$/,
        use: [
          'babel-loader',
          !isDev && { // ç”Ÿäº§ç¯å¢ƒå¯ç”¨ï¼Œå¼€å‘ç¯å¢ƒç¦ç”¨
            loader: './loaders/i18n-extract-loader.js',
            options: { /* ... */ },
          },
        ].filter(Boolean),
      },
    ],
  },
};
```

### 3. é…åˆ CI/CD è‡ªåŠ¨ç¿»è¯‘

```javascript
// scripts/auto-translate.js
const fs = require('fs');
const path = require('path');
const translate = require('@vitalets/google-translate-api'); // ç¤ºä¾‹ç¿»è¯‘API

async function autoTranslate() {
  const zhFile = path.join(__dirname, '../src/locales/zh-CN.json');
  const enFile = path.join(__dirname, '../src/locales/en-US.json');
  
  // è¯»å–ä¸­æ–‡æºæ–‡ä»¶
  const zhData = JSON.parse(fs.readFileSync(zhFile, 'utf-8'));
  let enData = {};
  
  // è¯»å–å·²æœ‰è‹±æ–‡æ–‡ä»¶ï¼ˆä¿ç•™å·²ç¿»è¯‘å†…å®¹ï¼‰
  if (fs.existsSync(enFile)) {
    enData = JSON.parse(fs.readFileSync(enFile, 'utf-8'));
  }
  
  // æ‰¹é‡ç¿»è¯‘æœªå¤„ç†é¡¹
  for (const [key, value] of Object.entries(zhData)) {
    if (!enData[key] || enData[key].startsWith('[TODO]')) {
      try {
        const res = await translate(value, { to: 'en' });
        enData[key] = res.text;
        console.log(`Translated: ${value} â†’ ${res.text}`);
      } catch (err) {
        enData[key] = value; // ç¿»è¯‘å¤±è´¥æ—¶ä½¿ç”¨åŸæ–‡
        console.error(`Translate failed: ${key}`, err.message);
      }
    }
  }
  
  // å†™å…¥ç¿»è¯‘ç»“æœ
  fs.writeFileSync(enFile, JSON.stringify(enData, null, 2), 'utf-8');
  console.log('âœ… Auto translation completed!');
}

autoTranslate();
```

åœ¨`package.json`ä¸­æ·»åŠ è„šæœ¬ï¼š
```json
{
  "scripts": {
    "translate": "node scripts/auto-translate.js",
    "build": "npm run translate && webpack"
  }
}
```

## ğŸ“Š æå–æ—¥å¿—

Loaderä¼šè‡ªåŠ¨ç”Ÿæˆ`extraction-log.txt`æ–‡ä»¶ï¼Œè®°å½•æ¯æ¬¡æå–çš„è¯¦ç»†ä¿¡æ¯ï¼š

```
===========================================
Extraction Time: 2025-11-18T10:30:00.000Z
Source File: /project/src/components/UserProfile.jsx
Extracted Count: 5
===========================================
user_yhxx_a1b2c3: ç”¨æˆ·ä¿¡æ¯
user_hghl_d4e5f6: æ¬¢è¿å›æ¥
user_bjzl_g7h8i9: ç¼–è¾‘èµ„æ–™
user_zsst_j0k1l2: è¿™æ˜¯æç¤º
user_xftc_m3n4o5: æ‚¬åœæŸ¥çœ‹

===========================================
Extraction Time: 2025-11-18T10:35:00.000Z
Source File: /project/src/components/Dashboard.jsx
Extracted Count: 18
===========================================
app_djcg_a1b2c3: ç‚¹å‡»æˆåŠŸï¼
app_sjmb_d4e5f6: æ•°æ®é¢æ¿
...
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä»£ç å¤‡ä»½**ï¼šé¦–æ¬¡ä½¿ç”¨å»ºè®®åœ¨æµ‹è¯•åˆ†æ”¯è¿è¡Œï¼Œé¿å…æ„å¤–ä¿®æ”¹ä¸šåŠ¡ä»£ç 
2. **å˜é‡æ–‡æœ¬å¤„ç†**ï¼šåŒ…å«å˜é‡çš„æ¨¡æ¿å­—ç¬¦ä¸²ï¼ˆå¦‚`ä½ å¥½${name}`ï¼‰ä¸ä¼šè¢«å¤„ç†ï¼Œéœ€æ‰‹åŠ¨æ”¹ä¸º`t('ä½ å¥½', {name})`æ ¼å¼
3. **åŠ¨æ€æ–‡æœ¬**ï¼šé€šè¿‡å˜é‡æ‹¼æ¥çš„æ–‡æœ¬ï¼ˆå¦‚`const text = 'æ¬¢è¿' + type`ï¼‰æ— æ³•æ£€æµ‹ï¼Œéœ€æå‰è§„èŒƒåŒ–
4. **ç‰¹æ®Šå±æ€§è¿‡æ»¤**ï¼šé»˜è®¤è¿‡æ»¤`className`ã€`style`ã€`key`ã€`ref`ç­‰å±æ€§ä¸­çš„æ–‡æœ¬ï¼Œå¦‚éœ€å¤„ç†å¯ä¿®æ”¹Loaderé…ç½®
5. **ç¿»è¯‘æ–‡ä»¶åˆå¹¶**ï¼šå¤šäººå¼€å‘æ—¶å»ºè®®å®šæœŸåˆå¹¶ç¿»è¯‘æ–‡ä»¶ï¼Œé¿å…Gitå†²çª

## ğŸ“ å®Œæ•´é¡¹ç›®ç»“æ„ç¤ºä¾‹

```
project/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ locales/              # ç¿»è¯‘æ–‡ä»¶ç›®å½•
â”‚   â”‚   â”œâ”€â”€ zh-CN.json        # ä¸­æ–‡ç¿»è¯‘
â”‚   â”‚   â”œâ”€â”€ en-US.json        # è‹±æ–‡ç¿»è¯‘
â”‚   â”‚   â”œâ”€â”€ ja-JP.json        # æ—¥æ–‡ç¿»è¯‘
â”‚   â”‚   â””â”€â”€ extraction-log.txt # æå–æ—¥å¿—
â”‚   â”œâ”€â”€ i18n/
â”‚   â”‚   â””â”€â”€ index.js          # i18nåˆå§‹åŒ–é…ç½®
â”‚   â”œâ”€â”€ components/           # ä¸šåŠ¡ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ UserProfile.jsx
â”‚   â”‚   â””â”€â”€ Dashboard.jsx
â”‚   â””â”€â”€ index.js              # é¡¹ç›®å…¥å£
â”œâ”€â”€ loaders/
â”‚   â””â”€â”€ i18n-extract-loader.js # æ ¸å¿ƒLoaderå®ç°
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ auto-translate.js     # è‡ªåŠ¨ç¿»è¯‘è„šæœ¬
â”œâ”€â”€ webpack.config.js         # Webpacké…ç½®
â””â”€â”€ package.json
```

## ğŸ¨ i18nåˆå§‹åŒ–é…ç½®ç¤ºä¾‹

```javascript
// src/i18n/index.js
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

// å¯¼å…¥ç¿»è¯‘æ–‡ä»¶
import zhCN from '../locales/zh-CN.json';
import enUS from '../locales/en-US.json';
import jaJP from '../locales/ja-JP.json';

i18n
  .use(initReactI18next)
  .init({
    resources: {
      'zh-CN': { translation: zhCN },
      'en-US': { translation: enUS },
      'ja-JP': { translation: jaJP },
    },
    lng: 'zh-CN', // é»˜è®¤è¯­è¨€
    fallbackLng: 'zh-CN', // å›é€€è¯­è¨€
    interpolation: {
      escapeValue: false, // Reactå·²è‡ªåŠ¨è½¬ä¹‰ï¼Œæ— éœ€é‡å¤å¤„ç†
    },
    keySeparator: false, // æ”¯æŒå«ç‚¹å·çš„Key
    nsSeparator: false,
  });

// å¯¼å‡ºä¾›Loaderä½¿ç”¨çš„tå‡½æ•°
export const t = i18n.t.bind(i18n);
export default i18n;
```

